#!/bin/bash

#获取信息
input(){
while [[ -z ${loc_ip} ]]; do
    loc_ip=$(whiptail --inputbox --nocancel "输入本机IP（现在安装Clash机器的ip）" 8 78 --title "输入本机IP" 3>&1 1>&2 2>&3)
done

while [[ -z ${gate_ip} ]]; do
    gate_ip=$(whiptail --inputbox --nocancel "输入网关IP（输入网关IP（主路由）" 8 78 --title "输入网关IP" 3>&1 1>&2 2>&3)
done
}


system_dep(){

yes|apt update && apt -y dist-upgrade

apt -y install sudo supervisor net-tools curl gzip unzip htop git make nftables

usermod -aG sudo yuanlam

echo " ">>/etc/sysctl.conf
echo "# made ipv4-forward in $(date +%F)">>/etc/sysctl.conf
echo 'net.ipv4.ip_forward=1'>>/etc/sysctl.conf
echo " ">>/etc/sysctl.conf
echo 'fs.file-max = 999999'>>/etc/sysctl.conf
echo 'net.core.rmem_max = 67108864'>>/etc/sysctl.conf
echo 'net.core.wmem_max = 67108864'>>/etc/sysctl.conf
echo 'net.core.rmem_default = 6291456'>>/etc/sysctl.conf
echo 'net.core.wmem_default = 6291456'>>/etc/sysctl.conf
echo 'net.core.netdev_max_backlog = 65535'>>/etc/sysctl.conf
echo 'net.core.somaxconn = 262114'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_tw_reuse = 1'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_fin_timeout = 30'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_time = 1200'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 8192'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_max_tw_buckets = 5000'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_mem = 8192 131072 67108864'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 10240 87380 12582912'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 10240 87380 12582912'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_mtu_probing = 1'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_notsent_lowat = 16384'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_syncookies = 1'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_max_orphans= 262114'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_fastopen = 3'>>/etc/sysctl.conf
echo 'net.ipv4.ip_local_port_range = 1024 65000'>>/etc/sysctl.conf
echo 'net.ipv4.udp_mem = 8192 131072 67108864'>>/etc/sysctl.conf
echo 'net.ipv4.udp_rmem_min = 4096'>>/etc/sysctl.conf
echo 'net.ipv4.udp_wmem_min = 4096'>>/etc/sysctl.conf
echo " ">>/etc/sysctl.conf
echo "# made bbr in $(date +%F)">>/etc/sysctl.conf
echo 'net.core.default_qdisc = fq'>>/etc/sysctl.conf
echo 'net.ipv4.tcp_congestion_control = bbr'>>/etc/sysctl.conf
echo " ">>/etc/sysctl.conf
echo "# made ipv6-disable in $(date +%F)">>/etc/sysctl.conf
echo 'net.ipv6.conf.all.disable_ipv6 = 1'>>/etc/sysctl.conf
echo 'net.ipv6.conf.default.disable_ipv6 = 1'>>/etc/sysctl.conf
echo 'net.ipv6.conf.lo.disable_ipv6 = 1'>>/etc/sysctl.conf
tail -5 /etc/sysctl.conf

sysctl -p

echo 'ListenAddress 0.0.0.0'>>/etc/ssh/sshd_config
echo 'AddressFamily inet'>>/etc/ssh/sshd_config

service sshd restart

echo 'DNSStubListener=no'>>/etc/systemd/resolved.conf
}


smartdns(){

wget $SM

tar zxf $SMV

cd smartdns

chmod +x ./install

./install -i

cd /etc/smartdns/

wget https://raw.githubusercontent.com/yuanlam/clash1step/test/smartdns.conf -O smartdns.conf

systemctl enable smartdns

systemctl start smartdns
}


unbound(){

apt install unbound -y

cat > /etc/default/unbound << EOF
RESOLVCONF="false"
ROOT_TRUST_ANCHOR_UPDATE="false"
EOF

cd /etc/unbound/

wget https://raw.githubusercontent.com/yuanlam/clash1step/test/unbound.conf -O unbound.conf

# 下载证书
wget ftp://FTP.INTERNIC.NET/domain/named.cache -O/etc/unbound/root.hints
# 生成unbound-control证书文件
unbound-control-setup

git clone https://github.com/felixonmars/dnsmasq-china-list.git --depth 1

cd dnsmasq-china-list

make SERVER=127.0.0.1@5301 unbound

cp *unbound.conf /etc/unbound/unbound.conf.d/
}


clash(){


wget -O /opt/clash.gz $CLS
cd /opt

gzip -d clash.gz
mv clash /usr/bin/clash
chmod +x /usr/bin/clash
# 为 clash 添加绑定低位端口的权限，这样运行 clash 的时候无需 root 权限
setcap cap_net_bind_service=+ep /usr/bin/clash

mkdir -p /home/yuanlam/.config/clash

cd /home/yuanlam/.config/clash

touch config.yaml

wget https://github.com/haishanh/yacd/archive/gh-pages.zip

unzip gh-pages.zip

mv yacd-gh-pages/ dashboard/

chown -R yuanlam /home/yuanlam/

cat << EOF > /etc/systemd/system/clash.service
[Unit]
Description=clash daemon
[Service]
Type=simple
User=yuanlam
ExecStart=/usr/bin/clash -d /home/yuanlam/.config/clash/
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF


systemctl daemon-reload
#设置自启动

systemctl start clash.service

systemctl enable clash.service

sleep 5
}


ip_dns(){

cat << EOF > /etc/network/interfaces
source /etc/network/interfaces.d/*
auto lo
iface lo inet loopback
auto  $eth_n
iface $eth_n inet static
  address $loc_ip
  netmask 255.255.255.0
  gateway $gate_ip
  dns-nameservers $gate_ip
  mtu 1492
  mss 1452
EOF

echo "14******************************************************************"
}

dt_menu() {
 Mainmenu=$(whiptail --clear --ok-button "确定" --backtitle "version:20200326" --title "Clash一键安装" --menu --nocancel "
**********************************************************************************
简介：Clash一键安装
系统：>=debian10
**********************************************************************************
请选择需要安装的内容：
    " 22 86 5\
        "1" " Clash一键安装"\
        "4" " 退出" 3>&1 1>&2 2>&3)
    case $Mainmenu in
        1)
        input
        system_dep
        smartdns
        unbound
        clash
        ip_dns
        whiptail --title "Clash一键安装成功" --msgbox "
*************************************************************************
Clash安装成功，需要科学的设备请参照下面修改。软路由请自行修改。
设备网关：$loc_ip
设备DNS：198.18.0.1,198.18.0.2
Clash配置文件地址：/home/$user/.config/clash/config.yaml
Clash控制面板:http://$loc_ip:9090/ui/
SmartDNS配置文件地址：/etc/smartdns
undound配置文件地址：/etc/undound/
*************************************************************************" 18 78        
        clear
        ;;
        4)
        #exit
        clear
        whiptail --title "脚本已退出" --msgbox "真希望把你留住" 8 78
        ;;
        esac       
}

eth_n=$(ip --oneline link show up | grep -v "lo" | awk '{print$2;exit}' | cut -d':' -f1 | cut -d'@' -f1)
GFW_LIST="https://raw.githubusercontent.com/pzwsquare/dt_client/master/black/gfw_domain.conf"
SM="https://github.com/pymumu/smartdns/releases/download/Release30/smartdns.1.2020.02.25-2212.x86_64-linux-all.tar.gz"
SMV="smartdns.1.2020.02.25-2212.x86_64-linux-all.tar.gz"
CLS="https://github.com/Dreamacro/clash/releases/download/v0.19.0/clash-linux-amd64-v0.19.0.gz"
dt_menu
